{"version":3,"sources":["../index.js"],"names":["initialState","options","state","mode","context","handlers","middlewares","Provider","off","on","forceUpdate","value","props","children","Component","Consumer","lastProps","promise","promiseResult","component","__component","isClass","isComponent","Object","assign","renderResult","then","lastResult","result","default","success","failure","loading","normalizedProps","error","undefined","PureComponent","handler","push","index","indexOf","splice","notifyChange","target","i","length","use","arguments","app","view","get","stateToProps","set","newState","action","dispatcher","args","isMergingMode","process","reduce","next","current","newTarget","changed","key","hoc","prototype"],"mappings":"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","file":"index.js","sourcesContent":["import { Component, PureComponent, createContext, createElement } from \"react\";\r\n\r\nfunction isComponent(component) {\r\n  return (\r\n    typeof component === \"function\" &&\r\n    (component.prototype instanceof Component ||\r\n      component.prototype instanceof PureComponent)\r\n  );\r\n}\r\n\r\nexport default function(initialState = {}, options = {}) {\r\n  let state = initialState;\r\n  const { mode = \"merge\" } = options;\r\n  const context = createContext();\r\n  const handlers = [];\r\n  const middlewares = [];\r\n\r\n  class Provider extends Component {\r\n    componentDidMount() {\r\n      this.off = on(() => this.forceUpdate());\r\n    }\r\n\r\n    componentWillUnmount() {\r\n      this.off();\r\n    }\r\n\r\n    render() {\r\n      return createElement(\r\n        context.Provider,\r\n        { value: state },\r\n        this.props.children(state)\r\n      );\r\n    }\r\n  }\r\n\r\n  class Consumer extends PureComponent {\r\n    render() {\r\n      if (this.lastProps === this.props) {\r\n        // is async component\r\n        if (this.promise) {\r\n          return this.promiseResult;\r\n        }\r\n      } else {\r\n        // props has been changed\r\n      }\r\n\r\n      this.lastProps = this.props;\r\n      const component = this.props.__component;\r\n      const isClass = isComponent(component);\r\n      const props = Object.assign({}, this.props);\r\n      delete props.__component;\r\n      if (isClass) {\r\n        return createElement(component, props);\r\n      }\r\n      const renderResult = component(props, this);\r\n      if (renderResult && typeof renderResult.then === \"function\") {\r\n        this.promise = renderResult;\r\n        renderResult.then(\r\n          result => {\r\n            if (this.promise !== renderResult) return;\r\n            if (this.lastResult === result) return;\r\n\r\n            this.lastResult = result;\r\n\r\n            if (typeof result === \"object\" && result.default) {\r\n              // support import() result\r\n              result = result.default;\r\n            }\r\n\r\n            const { success, failure, loading, ...normalizedProps } = props;\r\n\r\n            if (success) {\r\n              result = success(result);\r\n            }\r\n\r\n            if (typeof result === \"function\") {\r\n              if (isComponent(result)) {\r\n                result = createElement(result, normalizedProps);\r\n              } else {\r\n                result = result(normalizedProps);\r\n              }\r\n            }\r\n\r\n            this.promiseResult = result;\r\n            this.forceUpdate();\r\n          },\r\n          error => {\r\n            if (this.promise !== renderResult) return;\r\n            this.lastResult = error;\r\n            this.promiseResult =\r\n              typeof props.failure === \"function\"\r\n                ? props.failure(error)\r\n                : props.failure !== undefined\r\n                  ? props.failure\r\n                  : error;\r\n          }\r\n        );\r\n        return props.loading === undefined ? null : props.loading;\r\n      }\r\n      return renderResult;\r\n    }\r\n  }\r\n\r\n  function on(handler) {\r\n    handlers.push(handler);\r\n    return function() {\r\n      const index = handlers.indexOf(handler);\r\n      if (index !== -1) {\r\n        handlers.splice(index, 1);\r\n      }\r\n    };\r\n  }\r\n\r\n  function notifyChange(target) {\r\n    for (let i = 0, length = handlers.length; i < length; i++) {\r\n      handlers[i](state);\r\n    }\r\n  }\r\n\r\n  function use() {\r\n    middlewares.push(...arguments);\r\n  }\r\n\r\n  function app(view) {\r\n    return createElement(Provider, {}, view);\r\n  }\r\n\r\n  function get() {\r\n    if (!arguments.length) return state;\r\n    if (arguments.length > 1) {\r\n      const stateToProps = arguments[0];\r\n      const component = arguments[1];\r\n      return function(props) {\r\n        return createElement(context.Consumer, {}, state =>\r\n          createElement(\r\n            Consumer,\r\n            Object.assign(\r\n              { __component: component },\r\n              stateToProps(state, props)\r\n            )\r\n          )\r\n        );\r\n      };\r\n    }\r\n    const view = arguments[0];\r\n    return function(props) {\r\n      return createElement(context.Consumer, {}, state => view(state, props));\r\n    };\r\n  }\r\n\r\n  function set(newState, target) {\r\n    if (typeof newState === \"function\") {\r\n      const action = newState;\r\n\r\n      const dispatcher = function(...args) {\r\n        return set(action(state, ...args), target);\r\n      };\r\n\r\n      if (target === undefined) {\r\n        target = dispatcher;\r\n      }\r\n\r\n      return dispatcher;\r\n    }\r\n\r\n    let isMergingMode = mode === \"merge\";\r\n    const context = { get, set };\r\n    const process = result => {\r\n      middlewares.reduce(\r\n        (next, current) => {\r\n          return function(result, newTarget) {\r\n            current(context)(next)(\r\n              result,\r\n              newTarget === undefined ? target : newTarget\r\n            );\r\n          };\r\n        },\r\n        function(result) {\r\n          if (result !== undefined && result !== null && result !== state) {\r\n            if (isMergingMode) {\r\n              let changed = false;\r\n              for (let key in result) {\r\n                if (result[key] !== state[key]) {\r\n                  changed = true;\r\n                  break;\r\n                }\r\n              }\r\n              if (!changed) return;\r\n              result = Object.assign({}, state, result);\r\n            }\r\n\r\n            state = result;\r\n            notifyChange(target);\r\n          }\r\n        }\r\n      )(result, target);\r\n\r\n      return state;\r\n    };\r\n\r\n    if (newState && typeof newState.then === \"function\") {\r\n      isMergingMode = true;\r\n      return newState.then(process);\r\n    }\r\n    return process(newState);\r\n  }\r\n  return {\r\n    app,\r\n    get,\r\n    set,\r\n    on,\r\n    use,\r\n    hoc: stateToProps => component => get(stateToProps, component)\r\n  };\r\n}\r\n"]}